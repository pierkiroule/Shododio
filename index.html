<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>La Voix du SHODO — Pinceau Organique</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;1,300&family=Inter:wght@200;400&display=swap');

    :root {
      --bg: #f4f1ea;
      --ink: #0d0d0d;
      --vermilion: #c9301e;
      --indigo: #253a4f;
      --ui-bg: rgba(255,255,255,0.9);
    }

    body {
      margin: 0;
      overflow: hidden;
      background: var(--bg);
      font-family: 'Inter', sans-serif;
      touch-action: none;
      user-select: none;
      position: fixed;
      width: 100%;
      height: 100%;
      -webkit-tap-highlight-color: transparent;
    }

    canvas {
      position: absolute;
      inset: 0;
      display: block;
    }

    #water-layer { z-index: 10; pointer-events: none; opacity: 0.6; mix-blend-mode: overlay; }
    #paper-layer { z-index: 5; }

    .paper-texture {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 20;
      opacity: 0.18;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      mix-blend-mode: multiply;
    }

    #ui-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px;
      z-index: 100;
      transition: opacity 0.4s ease;
    }

    .top-ui {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    #status-msg {
      font-size: 0.65rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--indigo);
      text-shadow: 0 1px 0 rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #rec-dot {
      width: 8px;
      height: 8px;
      background: var(--vermilion);
      border-radius: 50%;
      display: none;
    }
    #rec-dot.active { display: block; animation: pulse 1s infinite; }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

    #timer-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      opacity: 0;
      transition: opacity 0.5s;
    }

    #timer-display {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.5rem;
      color: var(--ink);
      line-height: 1;
    }

    #timer-bar-bg {
      width: 100px;
      height: 2px;
      background: rgba(0,0,0,0.1);
      margin-top: 5px;
      position: relative;
    }

    #timer-bar {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, var(--indigo), var(--ink), var(--vermilion));
      transform-origin: left;
      transform: scaleX(0);
    }

    #spectrum-viz {
      display: flex;
      gap: 4px;
      height: 4px;
      width: 60px;
      margin-top: 5px;
      opacity: 0;
      transition: opacity 0.5s;
    }
    .spec-bar { flex: 1; transform-origin: bottom; transform: scaleY(0); transition: transform 0.1s; }
    #spec-low { background: var(--indigo); }
    #spec-mid { background: var(--ink); }
    #spec-high { background: var(--vermilion); }


    .action-area {
      pointer-events: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .main-btn {
      padding: 12px 28px;
      border: 1px solid var(--ink);
      background: var(--ink);
      color: var(--bg);
      letter-spacing: 0.15em;
      font-size: 0.7rem;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 180px;
    }

    .main-btn.secondary {
      background: transparent;
      color: var(--ink);
      border: 1px solid var(--ink);
    }

    .bottom-ui {
      display: flex;
      justify-content: center;
      gap: 20px;
      pointer-events: auto;
      margin-bottom: env(safe-area-inset-bottom);
    }

    .btn-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.1);
      background: var(--ui-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--ink);
      font-size: 1rem;
    }

    .advanced-panel {
      pointer-events: auto;
      align-self: center;
      margin-top: 10px;
      padding: 12px 16px;
      background: var(--ui-bg);
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 14px;
      display: none;
      flex-direction: column;
      gap: 10px;
      width: min(320px, 90vw);
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    .advanced-panel.active { display: flex; }

    .advanced-title {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.25em;
      color: var(--indigo);
    }

    .advanced-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .pad-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap: 8px;
    }

    .pad-btn {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.2);
      background: rgba(255,255,255,0.6);
      color: var(--ink);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      cursor: pointer;
    }

    .pad-btn.playing {
      background: var(--ink);
      color: var(--bg);
    }

    .small-status {
      font-size: 0.6rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(0,0,0,0.6);
    }

    #boot-screen {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.8s ease, visibility 0.8s;
      text-align: center;
      padding: 20px;
    }

    #boot-screen h1 {
      font-family: 'Cormorant Garamond';
      letter-spacing: 0.15em;
      font-weight: 300;
      font-size: 2rem;
      color: var(--ink);
      margin-bottom: 0.5rem;
    }

    #boot-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

    #init-btn {
      margin-top: 40px;
      padding: 16px 32px;
      background: transparent;
      border: 1px solid var(--ink);
      color: var(--ink);
      font-size: 0.75rem;
      letter-spacing: 0.25em;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
    }

    #replay-overlay {
      position: fixed;
      inset: 0;
      background: #080808;
      z-index: 200;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    #replay-overlay.active { display: flex; }

    video {
      max-width: 100%;
      max-height: 80vh;
      box-shadow: 0 0 50px rgba(0,0,0,0.5);
      border: 1px solid #333;
    }

    .replay-controls {
      margin-top: 20px;
      display: flex;
      gap: 20px;
    }

    .replay-btn {
      color: white;
      border: 1px solid white;
      padding: 10px 20px;
      background: transparent;
      cursor: pointer;
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.2em;
    }
    .replay-btn:hover { background: white; color: black; }
  </style>
</head>

<body>

  <div id="boot-screen">
    <h1>LA VOIX DU SHODO</h1>
    <p style="font-size: 0.7rem; letter-spacing: 0.15em; opacity: 0.6; margin-top: 0;">RITUEL SPECTRAL</p>
    <button id="init-btn">Activer le Pinceau</button>
  </div>

  <div id="replay-overlay">
    <video id="final-video" playsinline loop controls></video>
    <div class="replay-controls">
      <button id="dl-video-btn" class="replay-btn">Sauvegarder Vidéo</button>
      <button id="close-replay-btn" class="replay-btn">Fermer</button>
    </div>
  </div>

  <div class="paper-texture"></div>
  <canvas id="paper-layer"></canvas>
  <canvas id="water-layer"></canvas>

  <div id="ui-layer">
    <div class="top-ui">
      <div id="status-msg">
        <div id="rec-dot"></div>
        <span id="status-text">1. Humidifier le papier</span>
      </div>

      <div id="timer-container">
        <div id="timer-display">5.0</div>
        <div id="timer-bar-bg"><div id="timer-bar"></div></div>
        <div id="spectrum-viz">
          <div id="spec-low" class="spec-bar"></div>
          <div id="spec-mid" class="spec-bar"></div>
          <div id="spec-high" class="spec-bar"></div>
        </div>
      </div>
    </div>

    <div class="action-area">
      <button id="main-btn" class="main-btn">Lancer le cycle</button>
      <button id="secondary-btn" class="main-btn secondary" style="display:none;">Terminer l'oeuvre</button>
    </div>

    <div class="bottom-ui">
      <div id="reset-btn" class="btn-circle" title="Tout effacer">↺</div>
      <div id="save-btn" class="btn-circle" title="Image PNG">↓</div>
      <div id="advanced-btn" class="btn-circle" title="Options avancées">⚙︎</div>
    </div>

    <div id="advanced-panel" class="advanced-panel">
      <div class="advanced-title">Options avancées</div>
      <div class="advanced-row">
        <div class="small-status" id="sample-status">Recorder 5s prêt</div>
        <button id="sample-rec-btn" class="main-btn secondary" style="min-width: auto; padding: 8px 12px;">Recorder 5s</button>
      </div>
      <div class="pad-grid" id="sample-pad-grid"></div>
    </div>
  </div>

  <script>
    const paper = document.getElementById("paper-layer");
    const water = document.getElementById("water-layer");
    const ctxP = paper.getContext("2d", { alpha: false });
    const ctxW = water.getContext("2d");

    const mask = document.createElement("canvas");
    const ctxM = mask.getContext("2d", { willReadFrequently: true });

    let audioCtx, analyser, data, mediaStream;
    let phase = "HUMIDIFY";

    let startTime = 0;
    let timeLimit = 5000;
    let remainingTime = 0;

    let isDown = false;
    let lx, ly;
    let lastW = 0;
    let lastH = 0;

    const bands = { low: 0, mid: 0, high: 0 };
    const SILENCE_THRESHOLD = 0.01;

    let mediaRecorder;
    let recordedChunks = [];
    let isRecording = false;

    let sampleRecorder;
    let sampleChunks = [];
    let sampleCount = 0;
    const samplePads = [];

    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

    function initCanvasSize() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      if (Math.abs(w - lastW) < 50 && Math.abs(h - lastH) < 100) return;
      lastW = w;
      lastH = h;
      paper.width = water.width = mask.width = w;
      paper.height = water.height = mask.height = h;
      clearAll();
    }

    function clearAll() {
      ctxP.fillStyle = "#f4f1ea";
      ctxP.fillRect(0, 0, paper.width, paper.height);

      for (let i = 0; i < 60000; i++) {
        const shade = Math.random();
        ctxP.fillStyle = `rgba(80,80,75,${shade * 0.08})`;
        ctxP.fillRect(Math.random() * paper.width, Math.random() * paper.height, 1, 1);
      }

      ctxW.clearRect(0, 0, water.width, water.height);
      ctxM.clearRect(0, 0, mask.width, mask.height);
      ctxM.fillStyle = "black";
      ctxM.fillRect(0, 0, mask.width, mask.height);
    }

    async function startAudio() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaStream = stream;

        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        analyser.smoothingTimeConstant = 0.3;
        audioCtx.createMediaStreamSource(stream).connect(analyser);
        data = new Uint8Array(analyser.frequencyBinCount);

        setupRecorder();

        document.getElementById("boot-screen").classList.add("hidden");
        loop();
        requestAnimationFrame(audioLoop);
      } catch (e) {
        console.error(e);
        alert("Micro requis.");
      }
    }

    function setupRecorder() {
      try {
        const canvasStream = paper.captureStream(30);
        const combinedStream = new MediaStream([
          ...canvasStream.getVideoTracks(),
          ...mediaStream.getAudioTracks()
        ]);

        const options = { mimeType: "video/webm;codecs=vp9" };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
          options.mimeType = "video/webm";
          if (!MediaRecorder.isTypeSupported(options.mimeType)) options.mimeType = "";
        }

        mediaRecorder = new MediaRecorder(combinedStream, options);

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) recordedChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: recordedChunks[0] ? recordedChunks[0].type : "video/webm" });
          const url = URL.createObjectURL(blob);
          document.getElementById("final-video").src = url;

          document.getElementById("dl-video-btn").onclick = () => {
            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            a.download = `lavoixdushodo_${Date.now()}.webm`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
          };
          showReplay();
        };
      } catch (e) {
        console.error("Erreur recorder", e);
      }
    }

    function audioLoop() {
      if (!analyser) return requestAnimationFrame(audioLoop);
      analyser.getByteFrequencyData(data);

      const binCount = data.length;
      const lowLimit = Math.floor(binCount * 0.08);
      const midLimit = Math.floor(binCount * 0.45);

      let l = 0;
      let m = 0;
      let h = 0;

      for (let i = 0; i < binCount; i++) {
        const v = data[i] / 255;
        if (i < lowLimit) l += v;
        else if (i < midLimit) m += v;
        else h += v;
      }

      const rawL = (l / lowLimit) * 2.0;
      const rawM = (m / (midLimit - lowLimit)) * 2.5;
      const rawH = (h / (binCount - midLimit)) * 5.0;

      bands.low += (clamp(rawL, 0, 1) - bands.low) * 0.2;
      bands.mid += (clamp(rawM, 0, 1) - bands.mid) * 0.2;
      bands.high += (clamp(rawH, 0, 1) - bands.high) * 0.15;

      if (phase === "DRAWING") {
        document.getElementById("spec-low").style.transform = `scaleY(${bands.low})`;
        document.getElementById("spec-mid").style.transform = `scaleY(${bands.mid})`;
        document.getElementById("spec-high").style.transform = `scaleY(${bands.high})`;
      }

      requestAnimationFrame(audioLoop);
    }

    function drawWetTrace(x1, y1, x2, y2) {
      const d = Math.hypot(x2 - x1, y2 - y1);
      const steps = Math.max(1, Math.floor(d));
      ctxW.fillStyle = "rgba(255,255,255,0.15)";
      ctxM.fillStyle = "white";
      for (let i = 0; i <= steps; i++) {
        const t = i / steps;
        const x = x1 + (x2 - x1) * t;
        const y = y1 + (y2 - y1) * t;
        ctxW.beginPath();
        ctxW.arc(x, y, 30, 0, Math.PI * 2);
        ctxW.fill();
        ctxM.beginPath();
        ctxM.arc(x, y, 30, 0, Math.PI * 2);
        ctxM.fill();
      }
    }

    function drawSpectralBrush(x1, y1, x2, y2, life) {
      const totalVol = bands.low + bands.mid + bands.high;
      if (totalVol < SILENCE_THRESHOLD) return;

      const dist = Math.hypot(x2 - x1, y2 - y1);
      const steps = Math.max(1, Math.floor(dist));

      const speed = clamp(dist / 10, 0, 1);
      const pressure = 1.0 - (speed * 0.7);

      ctxP.save();
      ctxP.globalCompositeOperation = "multiply";

      const humid = isWet(x1, y1);

      let dx = x2 - x1;
      let dy = y2 - y1;
      const len = Math.sqrt(dx * dx + dy * dy);
      let nx = 0;
      let ny = 0;
      if (len > 0) {
        nx = -dy / len;
        ny = dx / len;
      }

      for (let i = 0; i <= steps; i++) {
        const t = i / steps;
        const cx = x1 + (x2 - x1) * t;
        const cy = y1 + (y2 - y1) * t;

        if (bands.low > 0.05) {
          const offset = (Math.random() - 0.5) * 15 * bands.low;
          const bx = cx + nx * offset;
          const by = cy + ny * offset;

          const size = (5 + bands.low * 25) * pressure;

          const alpha = (humid ? 0.03 : 0.06) * bands.low;

          ctxP.fillStyle = `rgba(37, 58, 79, ${alpha})`;
          ctxP.beginPath();
          ctxP.ellipse(bx, by, size, size * 0.6, Math.random() * Math.PI, 0, Math.PI * 2);
          ctxP.fill();
        }

        if (bands.mid > 0.02) {
          const brushWidth = (3 + bands.mid * 12) * pressure;
          const bristles = 12;

          for (let b = 0; b < bristles; b++) {
            const spread = (Math.random() - 0.5) * brushWidth * 2;

            if (speed > 0.5 && Math.random() > 0.4) continue;

            const mx = cx + nx * spread;
            const my = cy + ny * spread;

            const size = (0.5 + Math.random()) * pressure;

            let alpha = 0.5 * bands.mid;
            if (humid) alpha *= 0.4;

            ctxP.fillStyle = `rgba(13, 13, 13, ${alpha})`;
            ctxP.beginPath();
            ctxP.arc(mx, my, size, 0, Math.PI * 2);
            ctxP.fill();
          }
        }

        if (bands.high > 0.08) {
          if (Math.random() < 0.3) {
            const scatter = (5 + bands.high * 30);
            const hx = cx + (Math.random() - 0.5) * scatter;
            const hy = cy + (Math.random() - 0.5) * scatter;

            const size = 0.5 + Math.random();
            const alpha = 0.6 * bands.high;

            ctxP.fillStyle = `rgba(201, 48, 30, ${alpha})`;
            ctxP.beginPath();
            ctxP.arc(hx, hy, size, 0, Math.PI * 2);
            ctxP.fill();
          }

          if (Math.random() < 0.05 * bands.high) {
            const len = 10 * bands.high;
            const ang = Math.random() * Math.PI * 2;
            ctxP.strokeStyle = `rgba(201, 48, 30, ${0.4 * bands.high})`;
            ctxP.lineWidth = 0.5;
            ctxP.beginPath();
            ctxP.moveTo(cx, cy);
            ctxP.lineTo(cx + Math.cos(ang) * len, cy + Math.sin(ang) * len);
            ctxP.stroke();
          }
        }
      }

      ctxP.restore();
    }

    function isWet(x, y) {
      const ix = clamp(Math.floor(x), 0, mask.width - 1);
      const iy = clamp(Math.floor(y), 0, mask.height - 1);
      return ctxM.getImageData(ix, iy, 1, 1).data[0] > 100;
    }

    function handleMove(e) {
      if (!isDown) return;
      const p = e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY };
      const x = p.x;
      const y = p.y;

      if (lx !== undefined) {
        if (phase === "HUMIDIFY") {
          drawWetTrace(lx, ly, x, y);
        } else if (phase === "DRAWING") {
          const life = remainingTime / timeLimit;
          drawSpectralBrush(lx, ly, x, y, life);
        }
      }
      lx = x;
      ly = y;
    }

    function handleDown(e) {
      isDown = true;
      const p = e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY };
      lx = p.x;
      ly = p.y;
      handleMove(e);
    }

    function handleUp() {
      isDown = false;
      lx = undefined;
      ly = undefined;
    }

    document.body.addEventListener("pointerdown", handleDown);
    document.body.addEventListener("pointermove", handleMove);
    document.body.addEventListener("pointerup", handleUp);
    window.addEventListener("touchmove", e => e.preventDefault(), { passive: false });

    const mainBtn = document.getElementById("main-btn");
    const secBtn = document.getElementById("secondary-btn");
    const statusText = document.getElementById("status-text");
    const recDot = document.getElementById("rec-dot");
    const timerContainer = document.getElementById("timer-container");
    const specViz = document.getElementById("spectrum-viz");
    const advancedBtn = document.getElementById("advanced-btn");
    const advancedPanel = document.getElementById("advanced-panel");
    const sampleRecBtn = document.getElementById("sample-rec-btn");
    const sampleStatus = document.getElementById("sample-status");
    const samplePadGrid = document.getElementById("sample-pad-grid");

    mainBtn.onclick = () => {
      if (phase === "HUMIDIFY" || phase === "PAUSED") {
        startCycle();
      }
    };

    secBtn.onclick = () => {
      if (phase === "PAUSED") {
        phase = "FINISHED";
        finishRitual();
      }
    };

    document.getElementById("reset-btn").onclick = resetRitual;
    document.getElementById("save-btn").onclick = () => {
      const a = document.createElement("a");
      a.download = `lavoixdushodo_${Date.now()}.png`;
      a.href = paper.toDataURL();
      a.click();
    };

    document.getElementById("init-btn").onclick = () => {
      if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
        DeviceMotionEvent.requestPermission().then(() => startAudio()).catch(() => startAudio());
      } else {
        startAudio();
      }
    };

    document.getElementById("close-replay-btn").onclick = () => {
      document.getElementById("replay-overlay").classList.remove("active");
      recordedChunks = [];
    };

    advancedBtn.onclick = () => {
      advancedPanel.classList.toggle("active");
    };

    sampleRecBtn.onclick = () => {
      startSampleRecording();
    };

    function startCycle() {
      phase = "DRAWING";
      startTime = Date.now();
      remainingTime = timeLimit;

      if (mediaRecorder && mediaRecorder.state === "inactive") {
        mediaRecorder.start();
        isRecording = true;
      } else if (mediaRecorder && mediaRecorder.state === "paused") {
        mediaRecorder.resume();
        isRecording = true;
      }

      recDot.classList.add("active");
      mainBtn.style.display = "none";
      secBtn.style.display = "none";
      timerContainer.style.opacity = 1;
      specViz.style.opacity = 1;
      statusText.innerText = "Enregistrement en cours...";

      if (audioCtx && audioCtx.state === "suspended") audioCtx.resume();
    }

    function pauseCycle() {
      phase = "PAUSED";

      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.pause();
        isRecording = false;
      }

      recDot.classList.remove("active");
      mainBtn.innerText = "Nouveau Cycle";
      mainBtn.style.display = "block";
      secBtn.style.display = "block";
      statusText.innerText = "Pause. Ajoutez ou terminez.";
    }

    function finishRitual() {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }

      timerContainer.style.opacity = 0;
      ctxW.clearRect(0, 0, water.width, water.height);
      mainBtn.style.display = "none";
      secBtn.style.display = "none";
      statusText.innerText = "Rituel Terminé";
      recDot.classList.remove("active");
    }

    function showReplay() {
      document.getElementById("replay-overlay").classList.add("active");
      const v = document.getElementById("final-video");
      v.play();
    }

    function resetRitual() {
      phase = "HUMIDIFY";
      clearAll();
      recordedChunks = [];

      mainBtn.innerText = "Lancer le cycle";
      mainBtn.style.display = "block";
      secBtn.style.display = "none";

      timerContainer.style.opacity = 0;
      statusText.innerText = "1. Humidifier le papier";
      recDot.classList.remove("active");
    }

    function startSampleRecording() {
      if (!mediaStream) {
        sampleStatus.innerText = "Activez le micro d'abord.";
        return;
      }

      if (!sampleRecorder) {
        sampleRecorder = new MediaRecorder(mediaStream);
        sampleRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) sampleChunks.push(event.data);
        };

        sampleRecorder.onstop = () => {
          const blob = new Blob(sampleChunks, { type: sampleChunks[0] ? sampleChunks[0].type : "audio/webm" });
          sampleChunks = [];
          const url = URL.createObjectURL(blob);
          sampleCount += 1;
          const label = `Pad ${sampleCount}`;
          const padBtn = document.createElement("button");
          padBtn.className = "pad-btn";
          padBtn.textContent = label;
          padBtn.onclick = () => {
            const audio = new Audio(url);
            padBtn.classList.add("playing");
            audio.onended = () => padBtn.classList.remove("playing");
            audio.play();
          };
          samplePads.push({ label, url });
          samplePadGrid.appendChild(padBtn);
          sampleStatus.innerText = `${label} prêt.`;
          sampleRecBtn.disabled = false;
          sampleRecBtn.innerText = "Recorder 5s";
        };
      }

      if (sampleRecorder.state === "recording") return;

      sampleStatus.innerText = "Enregistrement 5s...";
      sampleRecBtn.disabled = true;
      sampleRecBtn.innerText = "En cours...";
      sampleChunks = [];
      sampleRecorder.start();

      setTimeout(() => {
        if (sampleRecorder && sampleRecorder.state === "recording") {
          sampleRecorder.stop();
        }
      }, 5000);
    }

    function loop() {
      if (phase === "DRAWING") {
        const elapsed = Date.now() - startTime;
        remainingTime = Math.max(0, timeLimit - elapsed);
        const ratio = remainingTime / timeLimit;

        document.getElementById("timer-display").innerText = (remainingTime / 1000).toFixed(1);
        document.getElementById("timer-bar").style.transform = `scaleX(${ratio})`;

        if (remainingTime <= 0) {
          pauseCycle();
        }
      }
      requestAnimationFrame(loop);
    }

    window.addEventListener("resize", initCanvasSize);
    initCanvasSize();
  </script>
</body>
</html>
